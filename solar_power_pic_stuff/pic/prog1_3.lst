MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001         LIST p=16f877a ; Include file, change directory if needed
                      00002         INCLUDE "p16f877a.inc"
                      00001         LIST
                      00002 
                      00003 ;==========================================================================
                      00004 ;  MPASM PIC16F877A processor include
                      00005 ; 
                      00006 ;  (c) Copyright 1999-2011 Microchip Technology, All rights reserved
                      00007 ;==========================================================================
                      00008 
                      00555         LIST
                      00003 
                      00004         CBLOCK 0x20
  00000020            00005         mac_dest_1
  00000021            00006         mac_dest_2
  00000022            00007         mac_dest_3
  00000023            00008         mac_dest_4
  00000024            00009         mac_dest_5
  00000025            00010         mac_dest_6
  00000026            00011         mac_src_1
  00000027            00012         mac_src_2
  00000028            00013         mac_src_3
  00000029            00014         mac_src_4
  0000002A            00015         mac_src_5
  0000002B            00016         mac_src_6
  0000002C            00017         mac_type_1
  0000002D            00018         mac_type_2 ; 14 bytes
                      00019 
  0000002E            00020         ip_version_and_header_length
  0000002F            00021         ip_dummy
  00000030            00022         ip_length_1
  00000031            00023         ip_length_2
  00000032            00024         ip_packet_id_1
  00000033            00025         ip_packet_id_2
  00000034            00026         ip_flags_1
  00000035            00027         ip_flags_2
  00000036            00028         ip_ttl
  00000037            00029         ip_protocol
  00000038            00030         ip_header_checksum_1
  00000039            00031         ip_header_checksum_2
  0000003A            00032         ip_src_1
  0000003B            00033         ip_src_2
  0000003C            00034         ip_src_3
  0000003D            00035         ip_src_4
  0000003E            00036         ip_dest_1
  0000003F            00037         ip_dest_2
  00000040            00038         ip_dest_3
  00000041            00039         ip_dest_4 ; 20 bytes (34 bytes total)
                      00040 
  00000042            00041         udp_src_port_1
  00000043            00042         udp_src_port_2
  00000044            00043         udp_dest_port_1
  00000045            00044         udp_dest_port_2
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000046            00045         udp_length_1
  00000047            00046         udp_length_2
  00000048            00047         udp_checksum_1
  00000049            00048         udp_checksum_2 ; 8 bytes (42 bytes total)
                      00049 
  0000004A            00050         magic ; always 0x65
  0000004B            00051         eth_packet_type ; memory dump: 0x01
  0000004C            00052         version
  0000004D            00053         sleep_1
  0000004E            00054         sleep_2
  0000004F            00055         sleep_3
                      00056 
  00000050            00057         spi_device_id
  00000051            00058         spi_out_length
  00000052            00059         spi_out_pointer
  00000053            00060         spi_out_1
  00000054            00061         spi_out_2
  00000055            00062         spi_out_3
  00000056            00063         spi_out_4
  00000057            00064         spi_out_5
  00000058            00065         spi_out_6
  00000059            00066         spi_out_7
  0000005A            00067         spi_out_8
  0000005B            00068         spi_memory_dump
                      00069 
  0000005C            00070         ow_pd_byte ; presence detect (do we have anything on the wire?)
  0000005D            00071         ow_bits_left
  0000005E            00072         ow_buffer
  0000005F            00073         ow_current_device_0
  00000060            00074         ow_current_device_1
  00000061            00075         ow_current_device_2
  00000062            00076         ow_current_device_3
  00000063            00077         ow_current_device_4
  00000064            00078         ow_current_device_5
  00000065            00079         ow_current_device_6
  00000066            00080         ow_current_device_7
                      00081 
  00000067            00082         thermo1_msb
  00000068            00083         thermo1_lsb
  00000069            00084         thermo2_msb
  0000006A            00085         thermo2_lsb
  0000006B            00086         thermo3_msb
  0000006C            00087         thermo3_lsb
                      00088 
                      00089         ENDC
                      00090 
0000                  00091         ORG 0x000 ; start at the reset vector
0000   0000           00092         nop
                      00093 
0001   29BB           00094         GOTO main ; start the program
                      00095 
0002                  00096 wait_1sec
0002   3005           00097         MOVLW 0x05
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0003   00CF           00098         MOVWF sleep_3
0004                  00099 wait_1sec_loop1
0004   30FF           00100         MOVLW 0xFF
0005   00CE           00101         MOVWF sleep_2
0006   30FF           00102         MOVLW 0xFF
0007   00CD           00103         MOVWF sleep_1
0008                  00104 wait_1sec_loop2
0008   0BCD           00105         DECFSZ sleep_1, F
0009   2808           00106         GOTO wait_1sec_loop2
000A   0BCE           00107         DECFSZ sleep_2, F
000B   2808           00108         GOTO wait_1sec_loop2
000C   0BCF           00109         DECFSZ sleep_3, F
000D   2804           00110         GOTO wait_1sec_loop1
000E   0008           00111         RETURN
                      00112 
000F                  00113 wait_5us
000F   0000           00114         NOP              ;1us
0010   0000           00115         NOP              ;1us
0011   0BCD           00116         DECFSZ sleep_1,F ;1us or 2us
0012   280F           00117         GOTO wait_5us    ;2us
0013   3400           00118         RETLW 0          ;2us
                      00119 
                      00120 ;d wait3
                      00121 ;d      CALL wait
                      00122 ;d      CALL wait
                      00123 ;d      CALL wait
                      00124 ;d      RETURN
                      00125 
                      00126 ;d wait4
                      00127 ;d      CALL wait3
                      00128 ;d      CALL wait3
                      00129 ;d      CALL wait3
                      00130 ;d      RETURN
                      00131 
0014                  00132 init_vars
0014   30F4           00133         MOVLW 0xf4
0015   00A0           00134         MOVWF mac_dest_1
0016   306D           00135         MOVLW 0x6d
0017   00A1           00136         MOVWF mac_dest_2
0018   3004           00137         MOVLW 0x04
0019   00A2           00138         MOVWF mac_dest_3
001A   30E7           00139         MOVLW 0xe7
001B   00A3           00140         MOVWF mac_dest_4
001C   30B2           00141         MOVLW 0xb2
001D   00A4           00142         MOVWF mac_dest_5
001E   3034           00143         MOVLW 0x34
001F   00A5           00144         MOVWF mac_dest_6
0020   30E0           00145         MOVLW 0xE0
0021   00A6           00146         MOVWF mac_src_1
0022   30CB           00147         MOVLW 0xCB
0023   00A7           00148         MOVWF mac_src_2
0024   304E           00149         MOVLW 0x4E
0025   00A8           00150         MOVWF mac_src_3
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0026   305E           00151         MOVLW 0x5E
0027   00A9           00152         MOVWF mac_src_4    ; <<<
0028   3087           00153         MOVLW 0x87
0029   00AA           00154         MOVWF mac_src_5    ; <<<
002A   308E           00155         MOVLW 0x8E
002B   00AB           00156         MOVWF mac_src_6    ; <<<
002C   3008           00157         MOVLW 0x08
002D   00AC           00158         MOVWF mac_type_1
002E   3000           00159         MOVLW 0x00
002F   00AD           00160         MOVWF mac_type_2
                      00161 
0030   3045           00162         MOVLW 0x45
0031   00AE           00163         MOVWF ip_version_and_header_length
0032   3000           00164         MOVLW 0x00
0033   00AF           00165         MOVWF ip_dummy
0034   3000           00166         MOVLW 0x00
0035   00B0           00167         MOVWF ip_length_1    ; <<<
0036   3052           00168         MOVLW 0x52
0037   00B1           00169         MOVWF ip_length_2    ; <<< (including IP and UDP header)
0038   3000           00170         MOVLW 0x00
0039   00B2           00171         MOVWF ip_packet_id_1 ; <<<
003A   3000           00172         MOVLW 0x00
003B   00B3           00173         MOVWF ip_packet_id_2 ; <<< increment this before transmit
003C   3040           00174         MOVLW 0x40
003D   00B4           00175         MOVWF ip_flags_1
003E   3000           00176         MOVLW 0x00
003F   00B5           00177         MOVWF ip_flags_2
0040   3040           00178         MOVLW 0x40
0041   00B6           00179         MOVWF ip_ttl
0042   3011           00180         MOVLW 0x11
0043   00B7           00181         MOVWF ip_protocol
0044   30B8           00182         MOVLW 0xB8
0045   00B8           00183         MOVWF ip_header_checksum_1    ; <<<
0046   3075           00184         MOVLW 0x75
0047   00B9           00185         MOVWF ip_header_checksum_2    ; <<<
0048   30C0           00186         MOVLW 0xC0
0049   00BA           00187         MOVWF ip_src_1
004A   30A8           00188         MOVLW 0xA8
004B   00BB           00189         MOVWF ip_src_2
004C   3000           00190         MOVLW 0x00
004D   00BC           00191         MOVWF ip_src_3
004E   30C9           00192         MOVLW 0xC9
004F   00BD           00193         MOVWF ip_src_4
0050   30C0           00194         MOVLW 0xC0
0051   00BE           00195         MOVWF ip_dest_1
0052   30A8           00196         MOVLW 0xA8
0053   00BF           00197         MOVWF ip_dest_2
0054   3000           00198         MOVLW 0x00
0055   00C0           00199         MOVWF ip_dest_3
0056   300C           00200         MOVLW 0x0C
0057   00C1           00201         MOVWF ip_dest_4
                      00202 
0058   3018           00203         MOVLW 0x18
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0059   00C2           00204         MOVWF udp_src_port_1
005A   30F7           00205         MOVLW 0xF7
005B   00C3           00206         MOVWF udp_src_port_2
005C   3018           00207         MOVLW 0x18
005D   00C4           00208         MOVWF udp_dest_port_1
005E   30F8           00209         MOVLW 0xF8
005F   00C5           00210         MOVWF udp_dest_port_2
0060   3000           00211         MOVLW 0x00
0061   00C6           00212         MOVWF udp_length_1    ; <<<
0062   3009           00213         MOVLW 0x09
0063   00C7           00214         MOVWF udp_length_2    ; <<< (including UDP header)
0064   3000           00215         MOVLW 0x00           
0065   00C8           00216         MOVWF udp_checksum_1  ; ignore
0066   3000           00217         MOVLW 0x00
0067   00C9           00218         MOVWF udp_checksum_2  ; ignore
                      00219 
0068   3065           00220         MOVLW 0x65 ; "e"
0069   00CA           00221         MOVWF magic
006A   3001           00222         MOVLW 0x01 ; memory dump
006B   00CB           00223         MOVWF eth_packet_type
                      00224 
006C   3001           00225         MOVLW 0x01
006D   00CC           00226         MOVWF version
006E   0008           00227         RETURN
                      00228 
                      00229 ; ====================================================================== spi ==
006F                  00230 spi_init
006F   1283 1303      00231         BANKSEL PORTA ; BANK0
0071   1408           00232         BSF PORTD, 0
                      00233 
0072   1683 1303      00234         BANKSEL TRISA ; BANK1
0074   3040           00235         MOVLW 0x40
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
0075   0094           00236         MOVWF SSPSTAT
0076   1283 1303      00237         BANKSEL PORTA ; BANK0
0078   3020           00238         MOVLW 0x20
0079   0094           00239         MOVWF SSPCON
                      00240 
007A   3000           00241         MOVLW 0x00
007B   00DB           00242         MOVWF spi_memory_dump ; disable memory dump on next packet
                      00243 
007C   0008           00244         RETURN
                      00245 
007D                  00246 spi_send
                      00247         ;; select device
007D   1283 1303      00248         BANKSEL PORTA ; BANK0
007F   1008           00249         BCF PORTD, 0
                      00250 
                      00251         ;; send the bytes
0080   3053           00252         MOVLW spi_out_1           ; seek to the first byte
0081   0084           00253         MOVWF FSR                 ; our pointer is "file select register"
0082                  00254 spi_send_loop
0082   1394           00255         BCF SSPCON, 7             ; WCOL
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0083   0800           00256         MOVF INDF, W              ; load the byte
0084   0093           00257         MOVWF SSPBUF              ; send the byte
                      00258 ;d      MOVF FSR, W
                      00259 ;d      MOVWF PORTB
                      00260 ;d      CALL wait3
0085   1683 1303      00261         BANKSEL TRISA ; BANK1
0087                  00262 spi_send_wait
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
0087   1C14           00263         BTFSS SSPSTAT, BF
0088   2887           00264         GOTO spi_send_wait
0089   1283 1303      00265         BANKSEL PORTA ; BANK0
008B   0A84           00266         INCF FSR, F               ; increase the pointer
008C   0BD1           00267         DECFSZ spi_out_length, F  ; decrease the remaining byte counter
008D   2882           00268         GOTO spi_send_loop        ; go back if we have more bytes
                      00269 
                      00270         ; ;;;; memory dump option!
008E   1C5B           00271         BTFSS spi_memory_dump, 0
008F   2896           00272         GOTO spi_no_dump
0090   105B           00273         BCF spi_memory_dump, 0     ; disable further memory dumps (endless loop)
0091   3020           00274         MOVLW 0x20                 ; set the pointer to the first byte
0092   0084           00275         MOVWF FSR
0093   3060           00276         MOVLW 0x60                 ; whole BANK0 "General Purpose Registry" memory
0094   00D1           00277         MOVWF spi_out_length
                      00278 ;d      CALL led_blue_on
0095   2882           00279         GOTO spi_send_loop
                      00280 
0096                  00281 spi_no_dump
                      00282 ;d      CALL led_blue_off
                      00283 ;d      MOVLW 0x00
                      00284 ;d      MOVWF PORTB
                      00285 
                      00286         ;; deselect device
0096   1408           00287         BSF PORTD, 0
                      00288 ;d      CALL wait4
                      00289         
0097   0008           00290         RETURN
                      00291 
                      00292 ; ================================================================= ethernet ==
0098                  00293 eth_init
0098   3001           00294         MOVLW 0x01 ; = eth
0099   00D0           00295         MOVWF spi_device_id
                      00296 
                      00297         ;; eth: system reset (see doc 6.0)
009A   30FF           00298         MOVLW 0xFF ; SC (reset)
009B   00D3           00299         MOVWF spi_out_1
                      00300 
009C   3001           00301         MOVLW 0x01 ; spi: how many byte outputs follow
009D   00D1           00302         MOVWF spi_out_length
009E   207D           00303         CALL spi_send
                      00304 
009F   2002           00305         CALL wait_1sec
                      00306 
                      00307         ;; eth: select BANK0
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00A0   30A0           00308         MOVLW 0xA0 ; BFC
00A1   381F           00309         IORLW 0x1F ; ECON1 (1F)
00A2   00D3           00310         MOVWF spi_out_1
00A3   3003           00311         MOVLW 0x03 ; xxxxxx00
00A4   00D4           00312         MOVWF spi_out_2
                      00313 
00A5   3002           00314         MOVLW 0x02 ; spi: how many byte outputs follow
00A6   00D1           00315         MOVWF spi_out_length
00A7   207D           00316         CALL spi_send
                      00317 
                      00318 
                      00319         ;; eth: set receive buffer start and end pointers (see doc 6.1)
00A8   3040           00320         MOVLW 0x40 ; WCR
00A9   3808           00321         IORLW 0x08 ; ERXSTL
00AA   00D3           00322         MOVWF spi_out_1
00AB   3000           00323         MOVLW 0x00 ; ... ERXSTL
00AC   00D4           00324         MOVWF spi_out_2
00AD   3000           00325         MOVLW 0x00 ; ... ERXSTH
00AE   00D5           00326         MOVWF spi_out_3
00AF   30FF           00327         MOVLW 0xFF ; ... ERXNDL
00B0   00D6           00328         MOVWF spi_out_4
00B1   300F           00329         MOVLW 0x0F ; ... ERXNDH
00B2   00D7           00330         MOVWF spi_out_5
                      00331         
00B3   3005           00332         MOVLW 0x05 ;; spi: how many byte outputs follow
00B4   00D1           00333         MOVWF spi_out_length
00B5   207D           00334         CALL spi_send
                      00335 
                      00336 ;optimization...
                      00337 ;       ;; eth: select BANK2
                      00338 ;       MOVLW 0xA0 ; BFC
                      00339 ;       IORLW 0x1F ; ECON1 (1F)
                      00340 ;       MOVWF spi_out_1
                      00341 ;       MOVLW 0x03 ; xxxxxx00
                      00342 ;       MOVWF spi_out_2
                      00343 ;
                      00344 ;       MOVLW 0x02 ; spi: how many byte outputs follow
                      00345 ;       MOVWF spi_out_length
                      00346 ;       CALL spi_send
                      00347 
00B6   3080           00348         MOVLW 0x80 ; BFS
00B7   381F           00349         IORLW 0x1F ; ECON1
00B8   00D3           00350         MOVWF spi_out_1
00B9   3002           00351         MOVLW 0x02 ; xxxxxx1x => xxxxxx10
00BA   00D4           00352         MOVWF spi_out_2
                      00353 
00BB   3002           00354         MOVLW 0x02 ; spi: how many byte outputs follow
00BC   00D1           00355         MOVWF spi_out_length
00BD   207D           00356         CALL spi_send
                      00357 
                      00358 
                      00359         ;; init MAC parameters (see doc 6.5)
00BE   3040           00360         MOVLW 0x40 ; WCR
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00BF   3800           00361         IORLW 0x00 ; MACON1 (00)
00C0   00D3           00362         MOVWF spi_out_1
00C1   300D           00363         MOVLW 0x0D ; ... MACON1
00C2   00D4           00364         MOVWF spi_out_2
00C3   3000           00365         MOVLW 0x00 ; ... MACON2
00C4   00D5           00366         MOVWF spi_out_3
00C5   3077           00367         MOVLW 0x77 ; ... MACON3
00C6   00D6           00368         MOVWF spi_out_4
00C7   3003           00369         MOVLW 0x03 ; ... MACON4
00C8   00D7           00370         MOVWF spi_out_5
00C9   300F           00371         MOVLW 0x0F ; ... MABBIPG
00CA   00D8           00372         MOVWF spi_out_6
                      00373         
00CB   3006           00374         MOVLW 0x06 ;; spi: how many byte outputs follow
00CC   00D1           00375         MOVWF spi_out_length
00CD   207D           00376         CALL spi_send
                      00377 
                      00378         
                      00379         ;; init LEDs by writing the PHLCON register indirectly (see doc 2.6 and 3.3.2)
00CE   3040           00380         MOVLW 0x40 ; WCR
00CF   3814           00381         IORLW 0x14 ; MIREGADR (14)
00D0   00D3           00382         MOVWF spi_out_1
00D1   3014           00383         MOVLW 0x14 ; ... MIREGADR (14 = eth PHLCON)
00D2   00D4           00384         MOVWF spi_out_2
00D3   3000           00385         MOVLW 0x00 ; ... -
00D4   00D5           00386         MOVWF spi_out_3
00D5   3072           00387         MOVLW 0x72 ; ... MIWRL
00D6   00D6           00388         MOVWF spi_out_4
00D7   3004           00389         MOVLW 0x04 ; ... MIWRH
00D8   00D7           00390         MOVWF spi_out_5
                      00391         
00D9   3005           00392         MOVLW 0x05 ;; spi: how many byte outputs follow
00DA   00D1           00393         MOVWF spi_out_length
00DB   207D           00394         CALL spi_send
                      00395 
00DC   0008           00396         RETURN
                      00397 
                      00398 ;;; test function to turn on both LEDs on eth
                      00399 ;eth_leds_on
                      00400 ;       BANKSEL PORTA ; BANK0
                      00401 ;
                      00402 ;       MOVLW 0x01 ; = eth
                      00403 ;       MOVWF spi_device_id
                      00404 ;
                      00405 ;       ;; eth select BANK2
                      00406 ;       MOVLW 0xA0 ; BFC
                      00407 ;       IORLW 0x1F ; ECON1 (1F)
                      00408 ;       MOVWF spi_out_1
                      00409 ;       MOVLW 0x03
                      00410 ;       MOVWF spi_out_2
                      00411 ;
                      00412 ;       MOVLW 0x02 ; spi: how many byte outputs follow
                      00413 ;       MOVWF spi_out_length
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00414 ;       CALL spi_send
                      00415 ;
                      00416 ;       MOVLW 0x80 ; BFS
                      00417 ;       IORLW 0x1F ; ECON1 (1F)
                      00418 ;       MOVWF spi_out_1
                      00419 ;       MOVLW 0x02
                      00420 ;       MOVWF spi_out_2
                      00421 ;
                      00422 ;       MOVLW 0x02 ; spi: how many byte outputs follow
                      00423 ;       MOVWF spi_out_length
                      00424 ;       CALL spi_send
                      00425 ;
                      00426 ;
                      00427 ;       MOVLW 0x40 ; WCR
                      00428 ;       IORLW 0x14 ; MIREGADR (14)
                      00429 ;       MOVWF spi_out_1
                      00430 ;       MOVLW 0x14 ; ... MIREGADR (14 = eth PHLCON)
                      00431 ;       MOVWF spi_out_2
                      00432 ;       MOVLW 0x00 ; ... -
                      00433 ;       MOVWF spi_out_3
                      00434 ;       MOVLW 0x82 ; ... MIWRL
                      00435 ;       MOVWF spi_out_4
                      00436 ;       MOVLW 0x08 ; ... MIWRH
                      00437 ;       MOVWF spi_out_5
                      00438 ;       
                      00439 ;       MOVLW 0x05 ;; spi: how many byte outputs follow
                      00440 ;       MOVWF spi_out_length
                      00441 ;       CALL spi_send
                      00442 ;
                      00443 ;       RETURN
                      00444 
00DD                  00445 eth_send_packet
00DD   1283 1303      00446         BANKSEL PORTA ; BANK0
                      00447 
                      00448         ;; eth: select BANK0
00DF   30A0           00449         MOVLW 0xA0 ; BFC
00E0   381F           00450         IORLW 0x1F ; ECON1 (1F)
00E1   00D3           00451         MOVWF spi_out_1
00E2   3003           00452         MOVLW 0x03 ; xxxxxx00
00E3   00D4           00453         MOVWF spi_out_2
                      00454 
00E4   3002           00455         MOVLW 0x02 ; spi: how many byte outputs follow
00E5   00D1           00456         MOVWF spi_out_length
00E6   207D           00457         CALL spi_send
                      00458 
                      00459 
                      00460         ;; eth: set up ETXST (see doc 7.1.1)
00E7   3040           00461         MOVLW 0x40 ; WCR
00E8   3804           00462         IORLW 0x04 ; ETXSTL
00E9   00D3           00463         MOVWF spi_out_1
00EA   3000           00464         MOVLW 0x00 ; ... ETXSTL
00EB   00D4           00465         MOVWF spi_out_2
00EC   3010           00466         MOVLW 0x10 ; ... ETXSTH
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00ED   00D5           00467         MOVWF spi_out_3
                      00468         
00EE   3003           00469         MOVLW 0x03 ;; spi: how many byte outputs follow
00EF   00D1           00470         MOVWF spi_out_length
00F0   207D           00471         CALL spi_send
                      00472 
                      00473 
                      00474         ;; eth: set up EWRPT (see doc 7.1.1)
00F1   3040           00475         MOVLW 0x40 ; WCR
00F2   3802           00476         IORLW 0x02 ; EWRPTL
00F3   00D3           00477         MOVWF spi_out_1
00F4   3000           00478         MOVLW 0x00 ; ... EWRPTL
00F5   00D4           00479         MOVWF spi_out_2
00F6   3010           00480         MOVLW 0x10 ; ... EWRPTH
00F7   00D5           00481         MOVWF spi_out_3
                      00482         
00F8   3003           00483         MOVLW 0x03 ;; spi: how many byte outputs follow
00F9   00D1           00484         MOVWF spi_out_length
00FA   207D           00485         CALL spi_send
                      00486 
                      00487 
                      00488         ;; eth: send the "per packet control byte" and the data payload (see doc 7.1.2)
                      00489         ;;      the payload is actually the whole memory :)
00FB   3060           00490         MOVLW 0x60 ; WBM
00FC   381A           00491         IORLW 0x1A ; required argument
00FD   00D3           00492         MOVWF spi_out_1
00FE   3000           00493         MOVLW 0x00 ; the "per packet control byte"
00FF   00D4           00494         MOVWF spi_out_2
                      00495         
0100   145B           00496         BSF spi_memory_dump, 0 ; enable memory dump with next spi_send
                      00497 
0101   3002           00498         MOVLW 0x02 ;; spi: how many byte outputs follow (before the memory dump)
0102   00D1           00499         MOVWF spi_out_length
0103   207D           00500         CALL spi_send
                      00501         
                      00502 
                      00503         ;; eth: set up ETXND (see doc 7.1.3)
0104   3040           00504         MOVLW 0x40 ; WCR
0105   3806           00505         IORLW 0x06 ; ETXNDL
0106   00D3           00506         MOVWF spi_out_1
0107   3060           00507         MOVLW 0x60 ; ... ETXNDL
0108   00D4           00508         MOVWF spi_out_2
0109   3010           00509         MOVLW 0x10 ; ... ETXNDH
010A   00D5           00510         MOVWF spi_out_3
                      00511         
010B   3003           00512         MOVLW 0x03 ;; spi: how many byte outputs follow
010C   00D1           00513         MOVWF spi_out_length
010D   207D           00514         CALL spi_send
                      00515 
                      00516 
                      00517         ;; eth: clear EIR.TXIF (see doc 7.1.4)
010E   30A0           00518         MOVLW 0xA0 ; BFC
010F   381C           00519         IORLW 0x1C ; EIR
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0110   00D3           00520         MOVWF spi_out_1
0111   3008           00521         MOVLW 0x08 ; .TXIF => 0
0112   00D4           00522         MOVWF spi_out_2
                      00523         
0113   3002           00524         MOVLW 0x02 ;; spi: how many byte outputs follow
0114   00D1           00525         MOVWF spi_out_length
0115   207D           00526         CALL spi_send
                      00527 
                      00528 
                      00529         ;; eth: set EIE.TXIE (see doc 7.1.4)
0116   3080           00530         MOVLW 0x80 ; BFS
0117   381B           00531         IORLW 0x1B ; EIE
0118   00D3           00532         MOVWF spi_out_1
0119   3080           00533         MOVLW 0x80 ; .TXIF => 0
011A   00D4           00534         MOVWF spi_out_2
                      00535         
011B   3002           00536         MOVLW 0x02 ;; spi: how many byte outputs follow
011C   00D1           00537         MOVWF spi_out_length
011D   207D           00538         CALL spi_send
                      00539 
                      00540 
                      00541         ;; eth: set ECON1.TXRTS (see doc 7.1.5)
011E   3080           00542         MOVLW 0x80 ; BFS
011F   381F           00543         IORLW 0x1F ; ECON1
0120   00D3           00544         MOVWF spi_out_1
0121   3008           00545         MOVLW 0x08 ; .TXRTS => 1
0122   00D4           00546         MOVWF spi_out_2
                      00547         
0123   3002           00548         MOVLW 0x02 ;; spi: how many outputs follow
0124   00D1           00549         MOVWF spi_out_length
0125   207D           00550         CALL spi_send
                      00551 
                      00552         
0126   0008           00553         RETURN
                      00554 
                      00555 ; =================================================================== 1-wire ==
  0007                00556         constant OW_PORT=PORTC
  0087                00557         constant OW_TRIS=TRISC
  0007                00558         constant OW_BIT=7
                      00559 
                      00560 OW_HIZ:MACRO
                      00561 ;Force the DQ line into a high impedance (HiZ) state.
                      00562         BSF    STATUS,RP0      ; BANK1
                      00563         BSF    OW_TRIS, OW_BIT ; make DQ pin an input (HiZ)
                      00564         BCF    STATUS,RP0      ; BANK0
                      00565         ENDM
                      00566 
                      00567 OW_LO:MACRO
                      00568 ;Force the DQ line to a logic low.
                      00569         BCF STATUS,RP0      ; BANK0
                      00570         BCF OW_PORT, OW_BIT ; Clear the DQ bit
                      00571         BSF STATUS,RP0      ; BANK1
                      00572         BCF OW_PORT, OW_BIT ; Make DQ pin an output
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00573         BCF STATUS,RP0      ; BANK0
                      00574         ENDM
                      00575 
                      00576 OW_WAIT:MACRO TIME ; wait for TIME us (microseconds), must be in multiples of 5
                      00577         MOVLW (TIME/5)-1 ; 1us
                      00578         MOVWF sleep_1    ; 1us
                      00579         CALL wait_5us    ; 2us
                      00580         ENDM
                      00581 
0127                  00582 ow_strong_pullup
0127   1283 1303      00583         BANKSEL PORTA  ; BANK0
                      00584         OW_HIZ         ; bring it up
                          M ;Force the DQ line into a high impedance (HiZ) state.
0129   1683               M         BSF    STATUS,RP0      ; BANK1
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
012A   1787               M         BSF    OW_TRIS, OW_BIT ; make DQ pin an input (HiZ)
012B   1283               M         BCF    STATUS,RP0      ; BANK0
012C   2002           00585         CALL wait_1sec ; give power for > 750 ms
                      00586         OW_LO          ; bring down DQ
                          M ;Force the DQ line to a logic low.
012D   1283               M         BCF STATUS,RP0      ; BANK0
012E   1387               M         BCF OW_PORT, OW_BIT ; Clear the DQ bit
012F   1683               M         BSF STATUS,RP0      ; BANK1
0130   1387               M         BCF OW_PORT, OW_BIT ; Make DQ pin an output
0131   1283               M         BCF STATUS,RP0      ; BANK0
0132   0008           00587         RETURN
                      00588 
0133                  00589 ow_reset
0133   1283 1303      00590         BANKSEL PORTA         ; BANK0
                      00591         OW_HIZ                ; Start with the line high
                          M ;Force the DQ line into a high impedance (HiZ) state.
0135   1683               M         BSF    STATUS,RP0      ; BANK1
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
0136   1787               M         BSF    OW_TRIS, OW_BIT ; make DQ pin an input (HiZ)
0137   1283               M         BCF    STATUS,RP0      ; BANK0
0138   3000           00592         MOVLW 0x00
0139   00DC           00593         MOVWF ow_pd_byte      ; Clear the PD byte
                      00594         OW_LO                 ; bring down DQ
                          M ;Force the DQ line to a logic low.
013A   1283               M         BCF STATUS,RP0      ; BANK0
013B   1387               M         BCF OW_PORT, OW_BIT ; Clear the DQ bit
013C   1683               M         BSF STATUS,RP0      ; BANK1
013D   1387               M         BCF OW_PORT, OW_BIT ; Make DQ pin an output
013E   1283               M         BCF STATUS,RP0      ; BANK0
                      00595         OW_WAIT .500          ; ... for 500 us
013F   3063               M         MOVLW (.500/5)-1 ; 1us
0140   00CD               M         MOVWF sleep_1    ; 1us
0141   200F               M         CALL wait_5us    ; 2us
                      00596         OW_HIZ                ; bring it back up
                          M ;Force the DQ line into a high impedance (HiZ) state.
0142   1683               M         BSF    STATUS,RP0      ; BANK1
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
0143   1787               M         BSF    OW_TRIS, OW_BIT ; make DQ pin an input (HiZ)
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0144   1283               M         BCF    STATUS,RP0      ; BANK0
                      00597         OW_WAIT .70           ; ... for 70 us to wait for PD pulse
0145   300D               M         MOVLW (.70/5)-1  ; 1us
0146   00CD               M         MOVWF sleep_1    ; 1us
0147   200F               M         CALL wait_5us    ; 2us
0148   1F87           00598         BTFSS OW_PORT, OW_BIT ; read for a PD Pulse
0149   0ADC           00599         INCF ow_pd_byte, F    ; set PDBYTE to 1 if get a PD pulse
                      00600         OW_WAIT .400          ; wait 400us after PD pulse (kill the line)
014A   304F               M         MOVLW (.400/5)-1 ; 1us
014B   00CD               M         MOVWF sleep_1    ; 1us
014C   200F               M         CALL wait_5us    ; 2us
014D   0008           00601         RETURN
                      00602 
014E                  00603 ow_receive_byte
014E   1283 1303      00604         BANKSEL PORTA              ; BANK0
0150   3008           00605         MOVLW .8
0151   00DD           00606         MOVWF ow_bits_left         ; we are waiting for 8 bits
0152                  00607 ow_receive_byte_loop
                      00608     OW_LO                      ; bring down DQ
                          M ;Force the DQ line to a logic low.
0152   1283               M         BCF STATUS,RP0      ; BANK0
0153   1387               M         BCF OW_PORT, OW_BIT ; Clear the DQ bit
0154   1683               M         BSF STATUS,RP0      ; BANK1
0155   1387               M         BCF OW_PORT, OW_BIT ; Make DQ pin an output
0156   1283               M         BCF STATUS,RP0      ; BANK0
0157   0000           00609     NOP                        ; ... and wait 6us
0158   0000           00610     NOP
0159   0000           00611     NOP
015A   0000           00612     NOP
015B   0000           00613     NOP
015C   0000           00614     NOP
                      00615     OW_HIZ                     ; change to HiZ 
                          M ;Force the DQ line into a high impedance (HiZ) state.
015D   1683               M         BSF    STATUS,RP0      ; BANK1
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
015E   1787               M         BSF    OW_TRIS, OW_BIT ; make DQ pin an input (HiZ)
015F   1283               M         BCF    STATUS,RP0      ; BANK0
0160   0000           00616         NOP                        ; wait 4µs
0161   0000           00617         NOP
0162   0000           00618         NOP
0163   0000           00619         NOP                        
0164   0807           00620         MOVF OW_PORT, W            ; read DQ
0165   3980           00621         ANDLW 1<<OW_BIT            ; mask off the DQ bit
0166   3EFF           00622         ADDLW 0xFF                 ; C=1 if DQ=1: C=0 if DQ=0
0167   0CDE           00623         RRF ow_buffer, F           ; shift C into IOBYTE
                      00624         OW_WAIT .50                ; wait 50µs to end of time slot
0168   3009               M         MOVLW (.50/5)-1  ; 1us
0169   00CD               M         MOVWF sleep_1    ; 1us
016A   200F               M         CALL wait_5us    ; 2us
016B   0BDD           00625         DECFSZ ow_bits_left, F     ; decrement the bit counter
016C   2952           00626         GOTO ow_receive_byte_loop
016D   085E           00627         MOVF ow_buffer, W
016E   0008           00628         RETURN
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00629 
016F                  00630 ow_send_byte
016F   1283 1303      00631         BANKSEL PORTA          ; BANK0
0171   00DE           00632         MOVWF ow_buffer        ; send the byte from W to ow_buffer
0172   3008           00633         MOVLW .8
0173   00DD           00634         MOVWF ow_bits_left     ; we are sending 8 bits
0174                  00635 ow_send_byte_loop
                      00636         OW_LO                  ; bring down DQ
                          M ;Force the DQ line to a logic low.
0174   1283               M         BCF STATUS,RP0      ; BANK0
0175   1387               M         BCF OW_PORT, OW_BIT ; Clear the DQ bit
0176   1683               M         BSF STATUS,RP0      ; BANK1
0177   1387               M         BCF OW_PORT, OW_BIT ; Make DQ pin an output
0178   1283               M         BCF STATUS,RP0      ; BANK0
0179   0000           00637         NOP                    ; ... and wait 3us
017A   0CDE           00638         RRF ow_buffer,F        ; get the first bit by shifting the buffer rightwise (EXPLAIN!)
017B   1683           00639         BSF STATUS,RP0         ; BANK1
017C   1803           00640         BTFSC STATUS,C         ; if the first bit (LSB) is 1 ...
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
017D   1787           00641         BSF OW_TRIS,OW_BIT     ; ... then HiZ the output
017E   1283           00642         BCF STATUS,RP0         ; BANK0
                      00643         OW_WAIT .60            ; keep the output this way for 60us
017F   300B               M         MOVLW (.60/5)-1  ; 1us
0180   00CD               M         MOVWF sleep_1    ; 1us
0181   200F               M         CALL wait_5us    ; 2us
                      00644         OW_HIZ                 ; HiZ the output (even if it was HiZ'd before)
                          M ;Force the DQ line into a high impedance (HiZ) state.
0182   1683               M         BSF    STATUS,RP0      ; BANK1
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
0183   1787               M         BSF    OW_TRIS, OW_BIT ; make DQ pin an input (HiZ)
0184   1283               M         BCF    STATUS,RP0      ; BANK0
0185   0000           00645         NOP                    ; recovery time (2us total)
0186   0000           00646         NOP
0187   0BDD           00647         DECFSZ ow_bits_left, F ; one less bits left
0188   2974           00648         GOTO ow_send_byte_loop
0189   0008           00649         RETURN
                      00650 
                      00651 ; ===================================================================== main ==
018A                  00652 init
018A   1683 1303      00653         BANKSEL TRISA  ; BANK1
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
018C   0185           00654         CLRF TRISA     ; set all bits on PORTA to output
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
018D   0186           00655         CLRF TRISB     ; set all bits on PORTB to output
                      00656         ;;CLRF TRISC     ; set all bits on PORTC to output
018E   3010           00657         MOVLW b'00010000'
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
018F   0087           00658         MOVWF TRISC
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
0190   0188           00659         CLRF TRISD     ; set all bits on PORTD to output
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
0191   0189           00660         CLRF TRISE     ; set all bits on PORTE to output
                      00661 
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0192   1283 1303      00662         BANKSEL PORTA  ; BANK0
0194   0185           00663         CLRF PORTA
0195   0186           00664         CLRF PORTB
0196   0187           00665         CLRF PORTC
0197   0188           00666         CLRF PORTD
0198   0189           00667         CLRF PORTE
                      00668 
0199   21A3           00669         CALL led_red_on
                      00670 
019A   2002           00671         CALL wait_1sec
                      00672         
019B   2014           00673         CALL init_vars
019C   206F           00674         CALL spi_init
019D   2098           00675         CALL eth_init
                      00676 ;       CALL eth_leds_on
                      00677 
019E   21A7           00678         CALL led_red_off
019F   21AB           00679         CALL led_green_on
                      00680 
01A0   0008           00681         RETURN
                      00682 
01A1                  00683 measure_input_1
01A1   0008           00684         RETURN
                      00685 
01A2                  00686 measure_input_2
01A2   0008           00687         RETURN
                      00688 
01A3                  00689 led_red_on
01A3   1283 1303      00690         BANKSEL PORTA ; BANK0
01A5   1405           00691         BSF PORTA, 0
01A6   0008           00692         RETURN
                      00693 
01A7                  00694 led_red_off
01A7   1283 1303      00695         BANKSEL PORTA ; BANK0
01A9   1005           00696         BCF PORTA, 0
01AA   0008           00697         RETURN
                      00698 
01AB                  00699 led_green_on
01AB   1283 1303      00700         BANKSEL PORTA ; BANK0
01AD   1505           00701         BSF PORTA, 2
01AE   0008           00702         RETURN
                      00703 
01AF                  00704 led_green_off
01AF   1283 1303      00705         BANKSEL PORTA ; BANK0
01B1   1105           00706         BCF PORTA, 2
01B2   0008           00707         RETURN
                      00708 
01B3                  00709 led_blue_on
01B3   1283 1303      00710         BANKSEL PORTA ; BANK0
01B5   1485           00711         BSF PORTA, 1
01B6   0008           00712         RETURN
                      00713 
01B7                  00714 led_blue_off
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01B7   1283 1303      00715         BANKSEL PORTA ; BANK0
01B9   1085           00716         BCF PORTA, 1
01BA   0008           00717         RETURN
                      00718         
01BB                  00719 main
01BB   218A           00720         CALL init
                      00721 
01BC                  00722 loop
01BC   2002           00723         CALL wait_1sec
                      00724 
01BD   21AF           00725         CALL led_green_off
01BE   21A3           00726         CALL led_red_on
                      00727 
                      00728 ;       CALL ow_reset
                      00729 ;       MOVLW 0x33 ; find one device
                      00730 ;       CALL ow_send_byte
                      00731 ;       CALL ow_receive_byte
                      00732 ;       MOVWF ow_current_device_0
                      00733 ;       CALL ow_receive_byte
                      00734 ;       MOVWF ow_current_device_1
                      00735 ;       CALL ow_receive_byte
                      00736 ;       MOVWF ow_current_device_2
                      00737 ;       CALL ow_receive_byte
                      00738 ;       MOVWF ow_current_device_3
                      00739 ;       CALL ow_receive_byte
                      00740 ;       MOVWF ow_current_device_4
                      00741 ;       CALL ow_receive_byte
                      00742 ;       MOVWF ow_current_device_5
                      00743 ;       CALL ow_receive_byte
                      00744 ;       MOVWF ow_current_device_6
                      00745 ;       CALL ow_receive_byte
                      00746 ;       MOVWF ow_current_device_7
                      00747 
                      00748 ;       temperature sensors:
                      00749 ;       1: 1013 c1f5 0108 003b
                      00750 ;       2: 1033 9df5 0108 0039
                      00751 ;       3: 1079 94f5 0108 0070
                      00752 ;       4: 10f7 97f5 0108 00c7
                      00753 
                      00754 
01BF   2133           00755         CALL ow_reset
01C0   3055           00756         MOVLW 0x55 ; select device
01C1   216F           00757         CALL ow_send_byte
01C2   3010           00758         MOVLW 0x10
01C3   216F           00759         CALL ow_send_byte
01C4   3013           00760         MOVLW 0x13
01C5   216F           00761         CALL ow_send_byte
01C6   30C1           00762         MOVLW 0xC1
01C7   216F           00763         CALL ow_send_byte
01C8   30F5           00764         MOVLW 0xF5
01C9   216F           00765         CALL ow_send_byte
01CA   3001           00766         MOVLW 0x01
01CB   216F           00767         CALL ow_send_byte
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01CC   3008           00768         MOVLW 0x08
01CD   216F           00769         CALL ow_send_byte
01CE   3000           00770         MOVLW 0x00
01CF   216F           00771         CALL ow_send_byte
01D0   303B           00772         MOVLW 0x3B
01D1   216F           00773         CALL ow_send_byte
01D2   3044           00774         MOVLW 0x44 ; convert T
01D3   216F           00775         CALL ow_send_byte
01D4   2127           00776         CALL ow_strong_pullup
                      00777 
01D5   2133           00778         CALL ow_reset
01D6   3055           00779         MOVLW 0x55 ; select device
01D7   216F           00780         CALL ow_send_byte
01D8   3010           00781         MOVLW 0x10
01D9   216F           00782         CALL ow_send_byte
01DA   3013           00783         MOVLW 0x13
01DB   216F           00784         CALL ow_send_byte
01DC   30C1           00785         MOVLW 0xC1
01DD   216F           00786         CALL ow_send_byte
01DE   30F5           00787         MOVLW 0xF5
01DF   216F           00788         CALL ow_send_byte
01E0   3001           00789         MOVLW 0x01
01E1   216F           00790         CALL ow_send_byte
01E2   3008           00791         MOVLW 0x08
01E3   216F           00792         CALL ow_send_byte
01E4   3000           00793         MOVLW 0x00
01E5   216F           00794         CALL ow_send_byte
01E6   303B           00795         MOVLW 0x3B
01E7   216F           00796         CALL ow_send_byte
01E8   30BE           00797         MOVLW 0xBE ; read scratchpad
01E9   216F           00798         CALL ow_send_byte
01EA   214E           00799         CALL ow_receive_byte
01EB   00E8           00800         MOVWF thermo1_lsb
01EC   214E           00801         CALL ow_receive_byte
01ED   00E7           00802         MOVWF thermo1_msb
                      00803 
                      00804 
01EE   2133           00805         CALL ow_reset
01EF   3055           00806         MOVLW 0x55 ; select device
01F0   216F           00807         CALL ow_send_byte
01F1   3010           00808         MOVLW 0x10
01F2   216F           00809         CALL ow_send_byte
01F3   3033           00810         MOVLW 0x33
01F4   216F           00811         CALL ow_send_byte
01F5   309D           00812         MOVLW 0x9D
01F6   216F           00813         CALL ow_send_byte
01F7   30F5           00814         MOVLW 0xF5
01F8   216F           00815         CALL ow_send_byte
01F9   3001           00816         MOVLW 0x01
01FA   216F           00817         CALL ow_send_byte
01FB   3008           00818         MOVLW 0x08
01FC   216F           00819         CALL ow_send_byte
01FD   3000           00820         MOVLW 0x00
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01FE   216F           00821         CALL ow_send_byte
01FF   3039           00822         MOVLW 0x39
0200   216F           00823         CALL ow_send_byte
0201   3044           00824         MOVLW 0x44 ; convert T
0202   216F           00825         CALL ow_send_byte
0203   2127           00826         CALL ow_strong_pullup
                      00827 
0204   2133           00828         CALL ow_reset
0205   3055           00829         MOVLW 0x55 ; select device
0206   216F           00830         CALL ow_send_byte
0207   3010           00831         MOVLW 0x10
0208   216F           00832         CALL ow_send_byte
0209   3033           00833         MOVLW 0x33
020A   216F           00834         CALL ow_send_byte
020B   309D           00835         MOVLW 0x9D
020C   216F           00836         CALL ow_send_byte
020D   30F5           00837         MOVLW 0xF5
020E   216F           00838         CALL ow_send_byte
020F   3001           00839         MOVLW 0x01
0210   216F           00840         CALL ow_send_byte
0211   3008           00841         MOVLW 0x08
0212   216F           00842         CALL ow_send_byte
0213   3000           00843         MOVLW 0x00
0214   216F           00844         CALL ow_send_byte
0215   3039           00845         MOVLW 0x39
0216   216F           00846         CALL ow_send_byte
0217   30BE           00847         MOVLW 0xBE ; read scratchpad
0218   216F           00848         CALL ow_send_byte
0219   214E           00849         CALL ow_receive_byte
021A   00EA           00850         MOVWF thermo2_lsb
021B   214E           00851         CALL ow_receive_byte
021C   00E9           00852         MOVWF thermo2_msb
                      00853 
                      00854 
021D   2133           00855         CALL ow_reset
021E   3055           00856         MOVLW 0x55 ; select device
021F   216F           00857         CALL ow_send_byte
0220   3010           00858         MOVLW 0x10
0221   216F           00859         CALL ow_send_byte
0222   30F7           00860         MOVLW 0xf7
0223   216F           00861         CALL ow_send_byte
0224   3097           00862         MOVLW 0x97
0225   216F           00863         CALL ow_send_byte
0226   30F5           00864         MOVLW 0xF5
0227   216F           00865         CALL ow_send_byte
0228   3001           00866         MOVLW 0x01
0229   216F           00867         CALL ow_send_byte
022A   3008           00868         MOVLW 0x08
022B   216F           00869         CALL ow_send_byte
022C   3000           00870         MOVLW 0x00
022D   216F           00871         CALL ow_send_byte
022E   30C7           00872         MOVLW 0xC7
022F   216F           00873         CALL ow_send_byte
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 19


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0230   3044           00874         MOVLW 0x44 ; convert T
0231   216F           00875         CALL ow_send_byte
0232   2127           00876         CALL ow_strong_pullup
                      00877 
0233   2133           00878         CALL ow_reset
0234   3055           00879         MOVLW 0x55 ; select device
0235   216F           00880         CALL ow_send_byte
0236   3010           00881         MOVLW 0x10
0237   216F           00882         CALL ow_send_byte
0238   30F7           00883         MOVLW 0xf7
0239   216F           00884         CALL ow_send_byte
023A   3097           00885         MOVLW 0x97
023B   216F           00886         CALL ow_send_byte
023C   30F5           00887         MOVLW 0xF5
023D   216F           00888         CALL ow_send_byte
023E   3001           00889         MOVLW 0x01
023F   216F           00890         CALL ow_send_byte
0240   3008           00891         MOVLW 0x08
0241   216F           00892         CALL ow_send_byte
0242   3000           00893         MOVLW 0x00
0243   216F           00894         CALL ow_send_byte
0244   30C7           00895         MOVLW 0xC7
0245   216F           00896         CALL ow_send_byte
0246   30BE           00897         MOVLW 0xBE ; read scratchpad
0247   216F           00898         CALL ow_send_byte
0248   214E           00899         CALL ow_receive_byte
0249   00EC           00900         MOVWF thermo3_lsb
024A   214E           00901         CALL ow_receive_byte
024B   00EB           00902         MOVWF thermo3_msb
                      00903 
                      00904 
024C   20DD           00905         CALL eth_send_packet
024D   21A7           00906         CALL led_red_off
024E   21AB           00907         CALL led_green_on
024F   29BC           00908         GOTO loop
                      00909         END
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 20


SYMBOL TABLE
  LABEL                             VALUE 

ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADCS2                             00000006
ADDEN                             00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
BCLIE                             00000003
BCLIF                             00000003
BF                                00000000
BRGH                              00000002
C                                 00000000
C1INV                             00000004
C1OUT                             00000006
C2INV                             00000005
C2OUT                             00000007
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
CCP2IE                            00000000
CCP2IF                            00000000
CCP2M0                            00000000
CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1                             00000015
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2                             0000001B
CCPR2H                            0000001C
CCPR2L                            0000001B
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CIS                               00000003
CKE                               00000006
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 21


SYMBOL TABLE
  LABEL                             VALUE 

CKP                               00000004
CM0                               00000000
CM1                               00000001
CM2                               00000002
CMCON                             0000009C
CMIE                              00000006
CMIF                              00000006
CREN                              00000004
CSRC                              00000007
CVR0                              00000000
CVR1                              00000001
CVR2                              00000002
CVR3                              00000003
CVRCON                            0000009D
CVREN                             00000007
CVROE                             00000006
CVRR                              00000005
D                                 00000005
DATA_ADDRESS                      00000005
DC                                00000001
D_A                               00000005
D_NOT_A                           00000005
EEADR                             0000010D
EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEPGD                             00000007
F                                 00000001
FERR                              00000002
FSR                               00000004
GCEN                              00000007
GIE                               00000007
GO                                00000002
GO_DONE                           00000002
GO_NOT_DONE                       00000002
I2C_DATA                          00000005
I2C_READ                          00000002
I2C_START                         00000003
I2C_STOP                          00000004
IBF                               00000007
IBOV                              00000005
INDF                              00000000
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTF                              00000001
IRP                               00000007
NOT_A                             00000005
NOT_ADDRESS                       00000005
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 22


SYMBOL TABLE
  LABEL                             VALUE 

NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
OBF                               00000006
OERR                              00000001
OPTION_REG                        00000081
OW_BIT                            00000007
OW_HIZ                            
OW_LO                             
OW_PORT                           00000007
OW_TRIS                           00000087
OW_WAIT                           
P                                 00000004
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PORTD                             00000008
PORTE                             00000009
PR2                               00000092
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PSPIE                             00000007
PSPIF                             00000007
PSPMODE                           00000004
R                                 00000002
RA0                               00000000
RA1                               00000001
RA2                               00000002
RA3                               00000003
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 23


SYMBOL TABLE
  LABEL                             VALUE 

RA4                               00000004
RA5                               00000005
RB0                               00000000
RB1                               00000001
RB2                               00000002
RB3                               00000003
RB4                               00000004
RB5                               00000005
RB6                               00000006
RB7                               00000007
RBIE                              00000003
RBIF                              00000000
RC0                               00000000
RC1                               00000001
RC2                               00000002
RC3                               00000003
RC4                               00000004
RC5                               00000005
RC6                               00000006
RC7                               00000007
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
RD0                               00000000
RD1                               00000001
RD2                               00000002
RD3                               00000003
RD4                               00000004
RD5                               00000005
RD6                               00000006
RD7                               00000007
RE0                               00000000
RE1                               00000001
RE2                               00000002
READ_WRITE                        00000002
RP0                               00000005
RP1                               00000006
RSEN                              00000001
RX9                               00000006
RX9D                              00000000
R_NOT_W                           00000002
R_W                               00000002
S                                 00000003
SEN                               00000000
SMP                               00000007
SPBRG                             00000099
SPEN                              00000007
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 24


SYMBOL TABLE
  LABEL                             VALUE 

SREN                              00000005
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
SSPOV                             00000006
SSPSTAT                           00000094
STATUS                            00000003
SYNC                              00000004
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TMR0                              00000001
TMR0IE                            00000005
TMR0IF                            00000002
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISA0                            00000000
TRISA1                            00000001
TRISA2                            00000002
TRISA3                            00000003
TRISA4                            00000004
TRISA5                            00000005
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 25


SYMBOL TABLE
  LABEL                             VALUE 

TRISB                             00000086
TRISB0                            00000000
TRISB1                            00000001
TRISB2                            00000002
TRISB3                            00000003
TRISB4                            00000004
TRISB5                            00000005
TRISB6                            00000006
TRISB7                            00000007
TRISC                             00000087
TRISC0                            00000000
TRISC1                            00000001
TRISC2                            00000002
TRISC3                            00000003
TRISC4                            00000004
TRISC5                            00000005
TRISC6                            00000006
TRISC7                            00000007
TRISD                             00000088
TRISD0                            00000000
TRISD1                            00000001
TRISD2                            00000002
TRISD3                            00000003
TRISD4                            00000004
TRISD5                            00000005
TRISD6                            00000006
TRISD7                            00000007
TRISE                             00000089
TRISE0                            00000000
TRISE1                            00000001
TRISE2                            00000002
TRMT                              00000001
TX8_9                             00000006
TX9                               00000006
TX9D                              00000000
TXD8                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
UA                                00000001
W                                 00000000
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
Z                                 00000002
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_CONFIG                           00002007
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 26


SYMBOL TABLE
  LABEL                             VALUE 

_CP_ALL                           00001FFF
_CP_OFF                           00003FFF
_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
_DEVID1                           00002006
_HS_OSC                           00003FFE
_IDLOC0                           00002000
_IDLOC1                           00002001
_IDLOC2                           00002002
_IDLOC3                           00002003
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC                           00003FFF
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_1FOURTH                      00003BFF
_WRT_256                          00003DFF
_WRT_HALF                         000039FF
_WRT_OFF                          00003FFF
_XT_OSC                           00003FFD
__16F877A                         00000001
eth_init                          00000098
eth_packet_type                   0000004B
eth_send_packet                   000000DD
init                              0000018A
init_vars                         00000014
ip_dest_1                         0000003E
ip_dest_2                         0000003F
ip_dest_3                         00000040
ip_dest_4                         00000041
ip_dummy                          0000002F
ip_flags_1                        00000034
ip_flags_2                        00000035
ip_header_checksum_1              00000038
ip_header_checksum_2              00000039
ip_length_1                       00000030
ip_length_2                       00000031
ip_packet_id_1                    00000032
ip_packet_id_2                    00000033
ip_protocol                       00000037
ip_src_1                          0000003A
ip_src_2                          0000003B
ip_src_3                          0000003C
ip_src_4                          0000003D
ip_ttl                            00000036
ip_version_and_header_length      0000002E
led_blue_off                      000001B7
led_blue_on                       000001B3
led_green_off                     000001AF
led_green_on                      000001AB
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 27


SYMBOL TABLE
  LABEL                             VALUE 

led_red_off                       000001A7
led_red_on                        000001A3
loop                              000001BC
mac_dest_1                        00000020
mac_dest_2                        00000021
mac_dest_3                        00000022
mac_dest_4                        00000023
mac_dest_5                        00000024
mac_dest_6                        00000025
mac_src_1                         00000026
mac_src_2                         00000027
mac_src_3                         00000028
mac_src_4                         00000029
mac_src_5                         0000002A
mac_src_6                         0000002B
mac_type_1                        0000002C
mac_type_2                        0000002D
magic                             0000004A
main                              000001BB
measure_input_1                   000001A1
measure_input_2                   000001A2
ow_bits_left                      0000005D
ow_buffer                         0000005E
ow_current_device_0               0000005F
ow_current_device_1               00000060
ow_current_device_2               00000061
ow_current_device_3               00000062
ow_current_device_4               00000063
ow_current_device_5               00000064
ow_current_device_6               00000065
ow_current_device_7               00000066
ow_pd_byte                        0000005C
ow_receive_byte                   0000014E
ow_receive_byte_loop              00000152
ow_reset                          00000133
ow_send_byte                      0000016F
ow_send_byte_loop                 00000174
ow_strong_pullup                  00000127
sleep_1                           0000004D
sleep_2                           0000004E
sleep_3                           0000004F
spi_device_id                     00000050
spi_init                          0000006F
spi_memory_dump                   0000005B
spi_no_dump                       00000096
spi_out_1                         00000053
spi_out_2                         00000054
spi_out_3                         00000055
spi_out_4                         00000056
spi_out_5                         00000057
spi_out_6                         00000058
spi_out_7                         00000059
spi_out_8                         0000005A
MPASM  5.42                       PROG1_3.ASM   3-6-2012  0:16:13         PAGE 28


SYMBOL TABLE
  LABEL                             VALUE 

spi_out_length                    00000051
spi_out_pointer                   00000052
spi_send                          0000007D
spi_send_loop                     00000082
spi_send_wait                     00000087
thermo1_lsb                       00000068
thermo1_msb                       00000067
thermo2_lsb                       0000006A
thermo2_msb                       00000069
thermo3_lsb                       0000006C
thermo3_msb                       0000006B
udp_checksum_1                    00000048
udp_checksum_2                    00000049
udp_dest_port_1                   00000044
udp_dest_port_2                   00000045
udp_length_1                      00000046
udp_length_2                      00000047
udp_src_port_1                    00000042
udp_src_port_2                    00000043
version                           0000004C
wait_1sec                         00000002
wait_1sec_loop1                   00000004
wait_1sec_loop2                   00000008
wait_5us                          0000000F


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0240 : XXXXXXXXXXXXXXXX ---------------- ---------------- ----------------

All other memory blocks unused.

Program Memory Words Used:   592
Program Memory Words Free:  7600


Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :    13 reported,     0 suppressed

